#!/usr/bin/env php
<?php

date_default_timezone_set('UTC');
set_time_limit(0);
(@include_once __DIR__ . '/../vendor/autoload.php') || @include_once __DIR__ . '/../../../autoload.php';

use Symfony\Component\Console\Application;
use Doctrine\ORM\Tools\Console\ConsoleRunner;
use Doctrine\ORM\Tools\Setup;
require_once "vendor/autoload.php";

$isDevMode = true;
$config = Setup::createAnnotationMetadataConfiguration(array(__DIR__."/../src"), $isDevMode, null, null, false);
$conn = [
    'url' => 'mysql://root:root@localhost/orm-test',
];
$entityManager = \Doctrine\ORM\EntityManager::create($conn, $config);
$helperSet = ConsoleRunner::createHelperSet($entityManager);

$list = opendir(__DIR__ . '/../src/Chalasdev/Console/Command');
while (false !== ($filename = readdir($list))) {
    if (!in_array($filename, ['.', '..'])) {
        if (strpos($filename, 'Command.php') !== false) {
            $className = explode('.php', $filename);
            $classes[] = $className[0];
        }
    }
}
$app = new Application('chalasdev/cli-starter', '1.0.0');
$app->setHelperSet($helperSet);
Doctrine\ORM\Tools\Console\ConsoleRunner::addCommands($app);
foreach ($classes as $command) {
    $command = "Chalasdev\Console\Command\\".$command;
    $command = new $command;
    $app->add($command);
}
$app->run();
